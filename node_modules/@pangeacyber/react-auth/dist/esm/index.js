import{jsx as e,Fragment as t}from"react/jsx-runtime";import{useCallback as s,useRef as r,useEffect as o,createContext as a,useState as n,useMemo as i,useContext as c}from"react";import l from"axios";import*as u from"jose";class f{constructor(e,t=!1){if(!e.clientToken)throw new Error("A token is required");if(!e.domain)throw new Error("A domain is required");e.callbackUri||"undefined"==typeof window||(e.callbackUri=window.location.origin),this.config={...e}}async logout(e){const t={token:e};return await this.post("client/session/logout",t)}async validate(e){const t={token:e};return await this.post("client/token/check",t)}async userinfo(e){const t={code:e};return await this.post("client/userinfo",t)}async refresh(e,t){const s={user_token:e,refresh_token:t};return await this.post("client/session/refresh",s)}async jwks(){return await this.post("client/jwks",{})}async post(e,t){try{const s=await l.post(this.getUrl(e),t,this.getOptions());return{success:"Success"===s.data?.status,response:s.data}}catch(e){return{success:!1,response:this.getError(e)}}}getUrl(e){return`${this.config.domain.match(/^local\.?host(:\d{2,5})?$/)?"http":"https"}://authn.${this.config.domain}/v1/${e}`}getOptions(){return{headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.clientToken}`}}}getError(e){const t={status:"Error",summary:"",result:{}};return l.isAxiosError(e)&&e.response?(t.status=e.response.data.status,t.summary=e.response.data.summary,t.result=e.response.data.result):e.request?(t.summary=`${e.request.status} ${e.request.statusText}`,t.result=e.reqest):(t.summary="Unhandled error",t.result=e,console.log("Unhandled error",e)),t}}var d="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var p=function(e,t,s,r){var o=-1,a=null==e?0:e.length;for(r&&a&&(s=e[++o]);++o<a;)s=t(s,e[o],o,e);return s};var h=function(e){return function(t){return null==e?void 0:e[t]}}({"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss","Ā":"A","Ă":"A","Ą":"A","ā":"a","ă":"a","ą":"a","Ć":"C","Ĉ":"C","Ċ":"C","Č":"C","ć":"c","ĉ":"c","ċ":"c","č":"c","Ď":"D","Đ":"D","ď":"d","đ":"d","Ē":"E","Ĕ":"E","Ė":"E","Ę":"E","Ě":"E","ē":"e","ĕ":"e","ė":"e","ę":"e","ě":"e","Ĝ":"G","Ğ":"G","Ġ":"G","Ģ":"G","ĝ":"g","ğ":"g","ġ":"g","ģ":"g","Ĥ":"H","Ħ":"H","ĥ":"h","ħ":"h","Ĩ":"I","Ī":"I","Ĭ":"I","Į":"I","İ":"I","ĩ":"i","ī":"i","ĭ":"i","į":"i","ı":"i","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","ĸ":"k","Ĺ":"L","Ļ":"L","Ľ":"L","Ŀ":"L","Ł":"L","ĺ":"l","ļ":"l","ľ":"l","ŀ":"l","ł":"l","Ń":"N","Ņ":"N","Ň":"N","Ŋ":"N","ń":"n","ņ":"n","ň":"n","ŋ":"n","Ō":"O","Ŏ":"O","Ő":"O","ō":"o","ŏ":"o","ő":"o","Ŕ":"R","Ŗ":"R","Ř":"R","ŕ":"r","ŗ":"r","ř":"r","Ś":"S","Ŝ":"S","Ş":"S","Š":"S","ś":"s","ŝ":"s","ş":"s","š":"s","Ţ":"T","Ť":"T","Ŧ":"T","ţ":"t","ť":"t","ŧ":"t","Ũ":"U","Ū":"U","Ŭ":"U","Ů":"U","Ű":"U","Ų":"U","ũ":"u","ū":"u","ŭ":"u","ů":"u","ű":"u","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","Ż":"Z","Ž":"Z","ź":"z","ż":"z","ž":"z","Ĳ":"IJ","ĳ":"ij","Œ":"Oe","œ":"oe","ŉ":"'n","ſ":"s"}),w="object"==typeof d&&d&&d.Object===Object&&d,m="object"==typeof self&&self&&self.Object===Object&&self,_=(w||m||Function("return this")()).Symbol;var g=function(e,t){for(var s=-1,r=null==e?0:e.length,o=Array(r);++s<r;)o[s]=t(e[s],s,e);return o},y=Array.isArray,v=_,S=Object.prototype,k=S.hasOwnProperty,E=S.toString,I=v?v.toStringTag:void 0;var A=function(e){var t=k.call(e,I),s=e[I];try{e[I]=void 0;var r=!0}catch(e){}var o=E.call(e);return r&&(t?e[I]=s:delete e[I]),o},T=Object.prototype.toString;var b=A,C=function(e){return T.call(e)},R=_?_.toStringTag:void 0;var x=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":R&&R in Object(e)?b(e):C(e)},L=function(e){return null!=e&&"object"==typeof e};var M=g,O=y,P=function(e){return"symbol"==typeof e||L(e)&&"[object Symbol]"==x(e)},F=_?_.prototype:void 0,N=F?F.toString:void 0;var $=function e(t){if("string"==typeof t)return t;if(O(t))return M(t,e)+"";if(P(t))return N?N.call(t):"";var s=t+"";return"0"==s&&1/t==-Infinity?"-0":s},U=$;var j=function(e){return null==e?"":U(e)},V=h,Y=j,D=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,W=RegExp("[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]","g");var J=function(e){return(e=Y(e))&&e.replace(D,V).replace(W,"")},q=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g;var K=function(e){return e.match(q)||[]},z=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/;var G=function(e){return z.test(e)},Z="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",H="["+Z+"]",B="\\d+",Q="[\\u2700-\\u27bf]",X="[a-z\\xdf-\\xf6\\xf8-\\xff]",ee="[^\\ud800-\\udfff"+Z+B+"\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde]",te="(?:\\ud83c[\\udde6-\\uddff]){2}",se="[\\ud800-\\udbff][\\udc00-\\udfff]",re="[A-Z\\xc0-\\xd6\\xd8-\\xde]",oe="(?:"+X+"|"+ee+")",ae="(?:"+re+"|"+ee+")",ne="(?:[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]|\\ud83c[\\udffb-\\udfff])?",ie="[\\ufe0e\\ufe0f]?"+ne+("(?:\\u200d(?:"+["[^\\ud800-\\udfff]",te,se].join("|")+")[\\ufe0e\\ufe0f]?"+ne+")*"),ce="(?:"+[Q,te,se].join("|")+")"+ie,le=RegExp([re+"?"+X+"+(?:['’](?:d|ll|m|re|s|t|ve))?(?="+[H,re,"$"].join("|")+")",ae+"+(?:['’](?:D|LL|M|RE|S|T|VE))?(?="+[H,re+oe,"$"].join("|")+")",re+"?"+oe+"+(?:['’](?:d|ll|m|re|s|t|ve))?",re+"+(?:['’](?:D|LL|M|RE|S|T|VE))?","\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",B,ce].join("|"),"g");var ue=K,fe=G,de=j,pe=function(e){return e.match(le)||[]};var he=p,we=J,me=function(e,t,s){return e=de(e),void 0===(t=s?void 0:t)?fe(e)?pe(e):ue(e):e.match(t)||[]},_e=RegExp("['’]","g");var ge=function(e){return function(t){return he(me(we(t).replace(_e,"")),e,"")}}((function(e,t,s){return e+(s?"_":"")+t.toLowerCase()}));const ye="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",ve=e=>{let t="";const s=ye.length;for(let r=0;r<e;r++)t+=ye.charAt(Math.floor(Math.random()*s));return t},Se=e=>{if(0===e.length)return"";"string"==typeof e&&(e="undefined"!=typeof TextEncoder?(new TextEncoder).encode(e):new Uint8Array(e.split("").map((e=>e.charCodeAt(0)))));let t=BigInt("0x"+(e=>{let t="";for(let s=0;s<e.length;s++)t+=e[s].toString(16).padStart(2,"0");return t})(e));const s=[];for(;t>0;){const e=Number(t%58n);t/=58n,s.push(ye[e])}for(let t=0;0===e[t];t++)s.push(ye[0]);return s.reverse().join("")},ke=e=>Object.keys(e).map((t=>encodeURIComponent(ge(t))+"="+encodeURIComponent(e[t]))).join("&"),Ee=(e,t)=>{const s=(e.getTime()-t.getTime())/1e3;return Math.round(s)},Ie={useCookie:!1,cookieMaxAge:172800,cookieName:"pangea-token",refreshCookieName:"pangea-refresh"},Ae=/[?&]code=[^&]+/,Te=/[?&]state=[^&]+/,be=(e=window.location.search)=>Ae.test(e)&&Te.test(e);function Ce(e){return e?window.sessionStorage:window.localStorage}const Re=(e,t)=>{const s=Ce(t.useCookie),r=JSON.stringify(e);s.setItem(t.sessionKey,r)},xe=e=>{const t=Ce(e.useCookie).getItem(e.sessionKey);return t?JSON.parse(t):{}},Le=e=>{if(e.useCookie)return Fe(e.cookieName);return xe(e)?.user?.active_token?.token},Me=e=>{const t=Le(e)||"",s=(e=>e.useCookie?Fe(e.refreshCookieName):xe(e)?.user?.refresh_token?.token)(e)||"";return{sessionToken:t,refreshToken:s}},Oe=e=>{if(e.useCookie)return Pe(e.cookieName);const t=xe(e);return[t?.user?.refresh_token?.token||"",t?.user?.refresh_token?.expire||""]},Pe=e=>{const t=Ue()[e]||"",[s,r]=t.split(",");return[s||"",r||""]},Fe=e=>{const t=Ue()[e];if(t){const[e]=t.split(",");return e||""}return""},Ne=e=>{const t=new Date(e);return Ee(t,new Date)<25},$e=(e,t)=>{const{cookieDomain:s}=t;var r;return"localhost"!==(r=window.location.hostname)&&"127.0.0.1"!==r&&(e+="; Secure",void 0!==s&&(e+=`; domain=${s}`)),e},Ue=()=>document.cookie.split(";").map((e=>e.trim())).reduce(((e,t)=>{const[s,r]=t.split("=");return""!==s&&(e[s]=r),e}),{}),je=(e,t="",s)=>{const{cookieMaxAge:r}=s;let o=`${e}=${t}; path=/; max-age=${r}`;o=$e(o,s),document.cookie=o},Ve=(e,t)=>{let s=`${e}=; path=/; expires=${new Date(0).toUTCString()}; max-age=0`;s=$e(s,t),document.cookie=s},Ye=(e,t)=>{const s=e.active_token?.token||"",r=e.refresh_token?.token||"",o=`${s},${e.active_token?.expire||""}`,a=`${r},${e.refresh_token?.expire||""}`;je(t.cookieName,o,t),je(t.refreshCookieName,a,t)},De=e=>{Ve(e.cookieName,e),Ve(e.refreshCookieName,e)},We=e=>{const t=e.result?.active_token?.token?{...e.result.active_token}:{...e.result},s=e.result?.refresh_token?.token?{...e.result.refresh_token}:{},r=t.email,o={...t.profile};delete t.email,delete t.profile,delete s.email,delete s.profile;return{email:r,profile:o,active_token:t,refresh_token:s}},Je=(e,t,r)=>{const o=s((async()=>{const{success:t,response:s}=await e.jwks();if(t){if(s.result?.keys&&s.result.keys.length>0)return{keys:s.result.keys};console.warn("Error: empty JWKS response")}}),[]),a=s((e=>{if(e?.expire){const t=new Date(e?.expire);return Ee(new Date,t)<86400}return!1}),[]),n=s((async()=>{const e=localStorage.getItem("jwks-cache"),t=JSON.parse(e||"{}");if(e&&a(t))return t.keySet;{const e=await o();if(e){const t={expire:Date.now(),keySet:e};return localStorage.setItem("jwks-cache",JSON.stringify(t)),e}return{keys:[]}}}),[]),i=s((async e=>{const t={};try{const s=await n();if(s?.keys?.length>0){const r=u.createLocalJWKSet(s),{payload:o,protectedHeader:a}=await u.jwtVerify(e,r),n=o.profile,i={email:o.email,profile:{first_name:n?.first_name,last_name:n?.first_name,phone:n?.phone},header:a,payload:o};t.user=i}else t.error="Missing JSON Web Key Set"}catch(e){console.warn("Error:",e),t.error="JWT validation failed"}return t}),[]),c=s((async s=>{const{success:r,response:o}=await e.validate(s),a={};return r?a.user=We(o):(De(t),a.error=o?.result?.summary||"Token verification error"),a}),[]);return s((async e=>{const s=t?.useJwt?await i(e):await c(e);if(r(s),s.user){const e=xe(t);e&&(s.user.active_token=e.user?.active_token,s.user.refresh_token=e.user?.refresh_token)}return s?.user}),[])},qe=(e,t,a,n)=>{const i=r(null);o((()=>(window.addEventListener("focus",l),window.addEventListener("blur",c),()=>{window.removeEventListener("focus",l),window.removeEventListener("blur",c),i.current&&(clearInterval(i.current),i.current=null)})),[]);const c=s((()=>{i.current&&(clearInterval(i.current),i.current=null)}),[]),l=s((()=>{n(!0),u(),n(!1),d()}),[]),u=s((()=>{const e=(e=>{if(e.useCookie){const[t,s]=Pe(e.cookieName);return s}return xe(e).user?.refresh_token?.expire||""})(t);e&&Ne(e)&&p()}),[]),f=s((()=>{i.current&&(clearInterval(i.current),i.current=null)}),[]),d=s((()=>{f(),i.current=window.setInterval((()=>{u()}),15e3)}),[]),p=s((async()=>{const{sessionToken:s,refreshToken:r}=Me(t),{success:o,response:n}=await e.refresh(s,r);if(o){const e=xe(t),s=We(n);e.user=s,Re(e,t),t.useCookie&&Ye(s,t),a({user:s})}else a({error:"Refresh failed"})}),[]);return{refresh:p,startTokenWatch:d,stopTokenWatch:f}},Ke=a({}),ze=({loginUrl:r,config:a,onLogin:c,cookieOptions:l={useCookie:!1},redirectPathname:u,redirectOnLogout:d=!1,useStrictStateCheck:p=!0,children:h})=>{const[w,m]=n(!1),[_,g]=n(!0),[y,v]=n(""),[S,k]=n(),E=i((()=>new f(a)),[a]),I=/\/$/,A=`${r.replace(I,"")}/authorize`,T=`${r.replace(I,"")}/signup`,b=`${r.replace(I,"")}/logout`,C={useJwt:a.useJwt,sessionKey:a.sessionKey||"pangea-session",...Ie,...l},R=s((e=>{if(e.user){const t=xe(C);if(m(!0),k(e.user),c){const e={userData:t.user,returnPath:window.location.pathname};c(e)}}else v(e.error||"Validation failed.");g(!1)}),[]),x=s((e=>{e.user?(k(e.user),m(!0)):U(),g(!1)}),[]),L=s((e=>{g(e)}),[]),M=Je(E,C,R),{refresh:O,startTokenWatch:P,stopTokenWatch:F}=qe(E,C,x,L);o((()=>{const[e,t]=Oe(C);be()?N():e?(t&&Ne(t)?O():M(e),P()):g(!1)}),[]);const N=async()=>{const e=window.location.search,t=new URLSearchParams(e),s=Ce(C.useCookie),r=s.getItem("state"),o=t.get("state"),n=t.get("code");t.delete("state"),t.delete("code");const i=t.toString(),c=i?`${window.location.pathname}?${i}`:window.location.pathname;if(history.pushState({},document.title,c),o&&n)if(o!==r&&p){v("Invalid session state"),g(!1)}else{const{success:e,response:t}=await E.userinfo(n);if(e){const e=t.result?.active_token?.token;if(e)(!a?.useJwt||a?.useJwt&&await M(e))&&Y(t);else{v("Missing Token")}}else v(t.summary);s.removeItem("state"),g(!1)}else{v("Missing required parameters"),g(!1)}},$=()=>{const e=window.location,t=window.location.search,s=new URLSearchParams(t),r=ve(32),o=Ce(C.useCookie);o.setItem("state",r),o.setItem("last-path",`${e.pathname}${e.search}`);let a=e.origin;"string"==typeof u&&(a+=u);const n=new URLSearchParams("");n.append("redirect_uri",a),n.append("state",r);const i=n.toString(),c=s.get("signup")?T:A,l=i?`${c}?${i}`:c;window.location.replace(l)},U=s((async()=>{const e=ve(32);if(d){let t=location.origin;"string"==typeof u&&(t+=u);const s=`${b}?${ke({redirectUri:t,state:e})}`;V(),window.location.replace(s)}else{const e=Le(C);if(e){const{success:t,response:s}=await E.logout(e);t?V():v(s.summary)}else V()}}),[]),j=s((()=>Le(C)),[]),V=()=>{C.useCookie&&De(C),F();Ce(C.useCookie).removeItem("pangea-session"),v(""),k(void 0),m(!1)},Y=e=>{const t=We(e),s=xe(C);s.user=t,Re(s,C);const r=Ce(C.useCookie),o={userData:t,returnPath:r.getItem("last-path")||"/",authState:r.getItem("state")};r.removeItem("last-path"),C.useCookie&&Ye(t,C),v(""),k(t),m(!0),P(),c&&c(o)},D=i((()=>({authenticated:w,loading:_,error:y,user:S,client:E,login:$,logout:U,getToken:j})),[w,_,y,S,E,$,U,j]);return e(Ke.Provider,{value:D,children:e(t,{children:h})})},Ge=()=>c(Ke),Ze=a({}),He=({config:r,cookieOptions:a={useCookie:!1},children:c})=>{const[l,u]=n(!1),[d,p]=n(!0),[h,w]=n(),[m,_]=n(),[g,y]=n(),v=i((()=>new f(r)),[r]),S={useJwt:r.useJwt,sessionKey:r.sessionKey||"pangea-session",...Ie,...a},k=s((e=>{e.user?(u(!0),_(e.user)):L(),p(!1)}),[]),E=s((e=>{e.user?(_(e.user),u(!0)):R(),p(!1)}),[]),I=s((e=>{p(e)}),[]),A=Je(v,S,k),{refresh:T,startTokenWatch:b,stopTokenWatch:C}=qe(v,S,E,I);o((()=>{const[e,t]=Oe(S);if(be()){const e=window.location.search,t=new URLSearchParams(e),s=t.get("state")||"",r=t.get("code")||"";y({state:s,code:r})}e?(t&&Ne(t)?T():A(e),b()):p(!1)}),[]);const R=s((async()=>{const e=Le(S);if(e){const{success:t,response:s}=await v.logout(e);t?L():w(s)}else L();C()}),[m]),x=s((()=>Le(S)),[]),L=()=>{S.useCookie&&De(S),w(void 0),_(void 0),u(!1)},M=s((e=>{const t=We(e),s=xe(S);s.user=t,Re(s,S),S.useCookie&&Ye(t,S),w(void 0),_(t),u(!0),b()}),[]),O=i((()=>({authenticated:l,loading:d,error:h,user:m,cbParams:g,client:v,logout:R,getToken:x,setFlowComplete:M})),[l,d,h,m,g,v,R,x,M]);return e(Ze.Provider,{value:O,children:e(t,{children:c})})},Be=()=>c(Ze);var Qe;!function(e){e.START="start",e.SIGNUP="signup",e.SIGNUP_PASSWORD="signup/password",e.SIGNUP_SOCIAL="signup/social",e.VERIFY_SOCIAL="verify/social",e.VERIFY_PASSWORD="verify/password",e.VERIFY_CAPTCHA="verify/captcha",e.VERIFY_EMAIL="verify/email",e.ENROLL_MFA_SELECT="enroll/mfa/select",e.ENROLL_MFA_START="enroll/mfa/start",e.ENROLL_MFA_COMPLETE="enroll/mfa/complete",e.VERIFY_MFA_SELECT="verify/mfa/select",e.VERIFY_MFA_START="verify/mfa/start",e.VERIFY_MFA_COMPLETE="verify/mfa/complete",e.RESET_PASSWORD="reset/password",e.MFA_SELECT="mfa/select",e.COMPLETE="complete"}(Qe||(Qe={}));const Xe={signin:!0,signup:!0},et={step:Qe.START,flowId:"",email:"",selectedMfa:"",mfaProviders:[],cancelMfa:!0,recaptchaKey:"",qrCode:"",passwordSignup:!0,socialSignup:{},verifyProvider:{},redirectUri:""};class tt extends f{constructor(e,t){super(e),this.options={...Xe,...t},this.state={...et}}initState(e){this.state={...this.state,...e}}async start(e){const t=`flow/${Qe.START}`,s=[];this.options.signup&&s.push("signup"),this.options.signin&&s.push("signin");const r={cb_uri:this.config.callbackUri,flow_types:s};e.email&&(r.email=e.email);const{success:o,response:a}=await this.post(t,r,!1);return o&&(r.email?(this.state.step=a.result?.next_step,this.state.email=r.email,a.result?.verify_social&&(this.state.verifyProvider={...a.result?.verify_social})):(null===a.result?.signup?.password_signup&&(this.state.passwordSignup=!0),a.result?.signup?.social_signup&&(this.state.socialSignup={...a.result.signup.social_signup})),this.state.flowId=a.result.flow_id,a.result?.verify_captcha?.site_key&&(this.state.recaptchaKey=a.result.verify_captcha.site_key)),{success:o,response:a}}async signupPassword(e){const t=`flow/${Qe.SIGNUP_PASSWORD}`,s={flow_id:this.state.flowId,first_name:e.firstName,last_name:e.lastName,password:e.password};return await this.post(t,s)}async signupSocial(e){const t=`flow/${Qe.SIGNUP_SOCIAL}`,s={flow_id:this.state.flowId,cb_code:e.cbCode,cb_state:e.cbState};return await this.post(t,s)}async verifySocial(e){const t=`flow/${Qe.VERIFY_SOCIAL}`,s={flow_id:this.state.flowId,cb_code:e.cbCode,cb_state:e.cbState};return await this.post(t,s)}async verifyPassword(e){const t=`flow/${Qe.VERIFY_PASSWORD}`,s={flow_id:this.state.flowId};return e.reset?s.reset=!0:s.password=e.password,await this.post(t,s)}async verifyCaptcha(e){const t=`flow/${Qe.VERIFY_CAPTCHA}`,s={flow_id:this.state.flowId,code:e.captchaCode};return await this.post(t,s)}async verifyEmail(e){const t=`flow/${Qe.VERIFY_EMAIL}`,s={flow_id:this.state.flowId,cb_code:e.cbCode,cb_state:e.cbState};return await this.post(t,s)}async enrollMfaStart(e){const t=`flow/${Qe.ENROLL_MFA_START}`,s={flow_id:this.state.flowId,mfa_provider:e.mfaProvider};"sms_otp"===e.mfaProvider&&e.phoneNumber&&(s.phone=e.phoneNumber);const{success:r,response:o}=await this.post(t,s);return r&&(o.result?.enroll_mfa_complete?.totp_secret?.qr_image&&(this.state.qrCode=o.result.enroll_mfa_complete.totp_secret.qr_image),this.state.step=o.result?.next_step),{success:r,response:o}}async enrollMfaComplete(e){const t=`flow/${Qe.ENROLL_MFA_COMPLETE}`,s={flow_id:this.state.flowId};return e.cancel?s.cancel=!0:s.code=e.code,await this.post(t,s)}async verifyMfaStart(e){const t=`flow/${Qe.VERIFY_MFA_START}`,s={flow_id:this.state.flowId,mfa_provider:e.mfaProvider};return await this.post(t,s)}async verifyMfaComplete(e){const t=`flow/${Qe.VERIFY_MFA_COMPLETE}`,s={flow_id:this.state.flowId};return e.cancel?s.cancel=!0:s.code=e.code,await this.post(t,s)}async resetPassword(e){const t=`flow/${Qe.RESET_PASSWORD}`,s={flow_id:this.state.flowId};return e.cancel?s.cancel=!0:(s.password=e.password,s.cb_code=e.cbCode,s.cb_state=e.cbState),await this.post(t,s)}async complete(){const e=`flow/${Qe.COMPLETE}`,t={flow_id:this.state.flowId};return await this.post(e,t)}reset(){this.state={...et}}async post(e,t,s=!0){try{const r=await l.post(this.getUrl(e),t,this.getOptions()),o=this.processResponse(r.data,s);return this.state.step===Qe.COMPLETE?await this.complete():this.state.step===Qe.VERIFY_MFA_START?await this.verifyMfaStart({mfaProvider:this.state.selectedMfa||""}):this.state.step===Qe.ENROLL_MFA_START&&"sms_otp"!==this.state.selectedMfa?await this.enrollMfaStart({mfaProvider:this.state.selectedMfa||""}):{success:o,response:r.data}}catch(e){return{success:!1,response:this.getError(e)}}}processResponse(e,t=!0){let s="Success"===e.status;return s&&t?(e.result?.verify_mfa_start?.mfa_providers?this.state.mfaProviders=null===e.result?.verify_mfa_start?.mfa_providers?[]:[...e.result.verify_mfa_start.mfa_providers]:e.result?.enroll_mfa_start?.mfa_providers&&(this.state.mfaProviders=null===e.result?.enroll_mfa_start?.mfa_providers?[]:[...e.result.enroll_mfa_start.mfa_providers]),!this.state.selectedMfa&&this.state.mfaProviders?.length&&(this.state.selectedMfa=this.state.mfaProviders[0]),e.result?.error&&(s=!1),this.state.step=e.result?.next_step):!s&&t&&e.result?.next_step&&(this.state.step=e.result.next_step),s}}const st=a({}),rt=({children:t})=>{const{client:r,cbParams:a,setFlowComplete:c}=Be(),l={clientToken:r.config.clientToken,domain:r.config.domain,callbackUri:r.config.callbackUri},u=i((()=>new tt(l)),[]),[f,d]=n(),[p,h]=n(),[w,m]=n(!1),[_,g]=n({});o((()=>{const e=v(),t={step:e.step||Qe.START},s=a?.code,r=a?.state;e.step&&(t.flowId=e.flow_id,t.recaptchaKey=e.recaptcha_key,t.qrCode=e.qr_code,t.selectedMfa=e.selected_mfa,t.mfaProviders=e.mfa_providers,t.email=e.email,g(t)),d(t.step),u.initState(t),t.step===Qe.START&&s&&r&&t.flowId?y(Qe.SIGNUP_SOCIAL,{cbCode:s,cbState:r}):t.step===Qe.START?y(Qe.START,{}):t.step===Qe.VERIFY_SOCIAL&&s&&r?y(Qe.VERIFY_SOCIAL,{cbCode:s,cbState:r}):t.step===Qe.VERIFY_EMAIL&&y(Qe.VERIFY_EMAIL,{cbCode:s,cbState:r})}),[]);const y=s((async(e,t)=>{switch(m(!0),e){case Qe.START:k(t);break;case Qe.SIGNUP_PASSWORD:E(t);break;case Qe.SIGNUP_SOCIAL:I(t);break;case Qe.VERIFY_PASSWORD:A(t);break;case Qe.VERIFY_SOCIAL:T(t);break;case Qe.VERIFY_EMAIL:b(t);break;case Qe.VERIFY_CAPTCHA:C(t);break;case Qe.ENROLL_MFA_START:R(t);break;case Qe.ENROLL_MFA_COMPLETE:x(t);break;case Qe.VERIFY_MFA_START:L(t);break;case Qe.VERIFY_MFA_COMPLETE:M(t);break;case Qe.RESET_PASSWORD:O(t);break;case Qe.ENROLL_MFA_SELECT:u.state.cancelMfa=t.cancel,P(Qe.ENROLL_MFA_SELECT);break;case Qe.VERIFY_MFA_SELECT:u.state.cancelMfa=t.cancel,P(Qe.VERIFY_MFA_SELECT);break;default:console.log("Invalid Flow State",e)}m(!1)}),[_]),v=()=>{const e=localStorage.getItem("pangea-authn-flow");if(e){return JSON.parse(e)}return{}},S=s((e=>{const t=v();t.step=e.step,t.flow_id=e.flowId,t.email=e.email,t.selected_mfa=e.selectedMfa,t.mfa_providers=e.mfaProviders,t.recaptcha_key=e.recaptchaKey,t.qr_code=e.qrCode;const s=JSON.stringify(t);localStorage.setItem("pangea-authn-flow",s)}),[]),k=async e=>{const{success:t,response:s}=await u.start(e);N(t,s)},E=async e=>{const{success:t,response:s}=await u.signupPassword(e);N(t,s)},I=async e=>{const{success:t,response:s}=await u.signupSocial(e);N(t,s)},A=async e=>{const{success:t,response:s}=await u.verifyPassword(e);N(t,s)},T=async e=>{const{success:t,response:s}=await u.verifySocial(e);N(t,s)},b=async e=>{const{success:t,response:s}=await u.verifyEmail(e);N(t,s)},C=async e=>{const{success:t,response:s}=await u.verifyCaptcha(e);N(t,s)},R=async e=>{const{success:t,response:s}=await u.enrollMfaStart(e);N(t,s)},x=async e=>{e.cancel&&e.mfaProvider&&(u.state.selectedMfa=e.mfaProvider);const{success:t,response:s}=await u.enrollMfaComplete(e);N(t,s)},L=async e=>{const{success:t,response:s}=await u.verifyMfaStart(e);N(t,s)},M=async e=>{e.cancel&&e.mfaProvider&&(u.state.selectedMfa=e.mfaProvider);const{success:t,response:s}=await u.verifyMfaComplete(e);N(t,s)},O=async e=>{e.cancel||(e.cbCode=a?.code,e.cbState=a?.state);const{success:t,response:s}=await u.resetPassword(e);N(t,s)},P=e=>{u.state.step=e,d(u.state.step),g({...u.state}),S(u.state)},F=s((()=>{u.reset(),h(void 0),y(Qe.START,{})}),[u,y]),N=(e,t)=>{e?(h(void 0),d(u.state.step),g({...u.state}),void 0===u.state.step&&t.result?.active_token?.token?(localStorage.removeItem("pangea-authn-flow"),c(t)):S(u.state)):(h(t),console.log("Error",t))},$=i((()=>({step:f,error:p,loading:w,flowData:_,callNext:y,reset:F,cbParams:a})),[f,p,w,_,y,F,a]);return e(st.Provider,{value:$,children:t})},ot=()=>c(st);export{rt as AuthFlowProvider,f as AuthNClient,tt as AuthNFlowClient,ze as AuthProvider,He as ComponentAuthProvider,Qe as FlowStep,Se as encode58,Fe as getTokenFromCookie,be as hasAuthParams,ke as toUrlEncoded,Ge as useAuth,ot as useAuthFlow,Be as useComponentAuth};
//# sourceMappingURL=index.js.map
